<!DOCTYPE html>
<html id="html">

<head>
    <title>Ear Training</title>
    <style type="text/css">
        body {
            margin: 1.35em !important;
        }

        html {
            background-color: black;
        }

        html, body {
            margin: 0;
            height: 100%;
            overflow: hidden;
        }

        body, h1, button, p, svg {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        h1, p {
            color: white;
        }

        p {
            display: inline;
        }

        button {
            width: 2.5em;
            height: 2.5em;
        }

        .correctlySelected {
            background-color: green;
        }

        .correct {
            background-color: greenyellow;
        }

        .incorrect {
            background-color: red;
        }
    </style>
</head>

<body scroll="no">
    <div id="singleNoteTraining">
        <h1>Single Note Training</h1>
        <p>Press Space to play a note</p>
        <br>
        <p id="noteText"></p>
        <br>
        <!--
        <div id="noteSelector">
            <button id="C" onclick="selectNote('C')">C</button>
            <button id="Db" onclick="selectNote('Db')">Db</button>
            <button id="D" onclick="selectNote('D')">D</button>
            <button id="Eb" onclick="selectNote('Eb')">Eb</button>
            <button id="E" onclick="selectNote('E')">E</button>
            <button id="F" onclick="selectNote('F')">F</button>
            <button id="Gb" onclick="selectNote('Gb')">Gb</button>
            <button id="G" onclick="selectNote('G')">G</button>
            <button id="Ab" onclick="selectNote('Ab')">Ab</button>
            <button id="A" onclick="selectNote('A')">A</button>
            <button id="Bb" onclick="selectNote('Bb')">Bb</button>
            <button id="B" onclick="selectNote('B')">B</button>
        </div>
        -->
        <br>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>
    <script src="https://tonejs.github.io/build/Tone.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript">
        const notes = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const noteKeys = ["A", "W", "S", "E", "D", "F", "T", "G", "Y", "H", "U", "J"];
        const middleNote = 54;
        var currentNote = -1;
        var selectedNotes = {};
        const keyWidth = 24 * 4;

        const sampler = new Tone.Sampler({
            urls: {
                "A0": "A0.mp3",
                "C1": "C1.mp3",
                "D#1": "Ds1.mp3",
                "F#1": "Fs1.mp3",
                "A1": "A1.mp3",
                "C2": "C2.mp3",
                "D#2": "Ds2.mp3",
                "F#2": "Fs2.mp3",
                "A2": "A2.mp3",
                "C3": "C3.mp3",
                "D#3": "Ds3.mp3",
                "F#3": "Fs3.mp3",
                "A3": "A3.mp3",
                "C4": "C4.mp3",
                "D#4": "Ds4.mp3",
                "F#4": "Fs4.mp3",
                "A4": "A4.mp3",
                "C5": "C5.mp3",
                "D#5": "Ds5.mp3",
                "F#5": "Fs5.mp3",
                "A5": "A5.mp3",
                "C6": "C6.mp3",
                "D#6": "Ds6.mp3",
                "F#6": "Fs6.mp3",
                "A6": "A6.mp3",
                "C7": "C7.mp3",
                "D#7": "Ds7.mp3",
                "F#7": "Fs7.mp3",
                "A7": "A7.mp3",
                "C8": "C8.mp3"
            },
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/",
        }).toDestination();

        function indexToNote(index, truncate) {
            if (truncate) {
                return truncateNote(notes[index % 12] + parseInt(index / 12));
            }
            return notes[index % 12] + parseInt(index / 12);
        }

        function truncateNote(note) {
            return note.slice(0, -1);
        }

        function playNote() {
            let firstNote = currentNote === -1;
            if (firstNote) {
                currentNote = middleNote;
            }
            let oldNote = currentNote;
            while (currentNote === oldNote) {
                currentNote += Math.floor(Math.random() * 25 - 12);
                if (currentNote <= middleNote - 18) {
                    currentNote += 12;
                } else if (currentNote >= middleNote + 18) {
                    currentNote -= 12;
                }
            }
            Tone.loaded().then(() => {
                sampler.triggerAttackRelease(indexToNote(currentNote), 1);
            });
            if (firstNote) {
                selectNote(indexToNote(currentNote));
            }
        }

        function revealNote() {
            document.getElementById("noteText").innerHTML = indexToNote(currentNote);
        }

        function hideNote() {
            document.getElementById("noteText").innerHTML = "";
        }

        function selectNote(note) {
            revealNote();
            deselectNotes();
            guessNote(note);
        }

        function guessNote(note) {
            if (note === indexToNote(currentNote, true)) {
                selectedNotes[note] = "correctlySelected";
            } else {
                selectedNotes[note] = "incorrect";
                selectedNotes[indexToNote(currentNote, true)] = "correct";
            }
            drawPiano();
        }

        function deselectNotes() {
            for (let i = 0; i < 12; i++) {
                selectedNotes[notes[i]] = "";
            }
        }

        /*function holdingShift(shift) {
            if (shift) {
                notes.forEach(function(currentValue, index) {document.getElementById(currentValue).innerHTML = noteKeys[index]});
            } else {
                notes.forEach(function(currentValue, index) {document.getElementById(currentValue).innerHTML = notes[index]});
            }
        }*/

        document.addEventListener("keydown", function(event) {
            switch (event.keyCode) {
                case 32: playNote(); event.preventDefault(); break;
                case 16: holdingShift(true); break;
                case 65: selectNote("C"); break;
                case 87: selectNote("Db"); break;
                case 83: selectNote("D"); break;
                case 69: selectNote("Eb"); break;
                case 68: selectNote("E"); break;
                case 70: selectNote("F"); break;
                case 84: selectNote("Gb"); break;
                case 71: selectNote("G"); break;
                case 89: selectNote("Ab"); break;
                case 72: selectNote("A"); break;
                case 85: selectNote("Bb"); break;
                case 74: selectNote("B"); break;
                case 49: selectPage("singleNoteTraining"); break;
                case 50: selectPage("intervalTraining"); break;
            }
        });

        document.addEventListener("keyup", function(event) {
            if (event.keyCode === 16) {
                holdingShift(false);
            }
        });

        function drawKey(x, y, width, height, fill) {
            svg.append("rect")
                .attr("x", x)
                .attr("y", y)
                .attr("width", width)
                .attr("height", height)
                .attr("fill", fill)
                .attr("stroke", "black")
                .attr("stroke-width", keyWidth / 18);
        }

        function drawKeyText(x, y, text, blackKey) {
            svg.append("text")
                .attr("x", x)
                .attr("y", y)
                .style("font-size", keyWidth * 0.4)
                .style("fill", blackKey ? "white" : "black")
                .style("text-anchor", "middle")
                .text(text);
        }

        var svg = d3.select("#singleNoteTraining")
            .append("svg")
            .attr("width", keyWidth * 7)
            .attr("height", keyWidth * 5);
        
        function drawPiano() {
            drawKey(0, 0, keyWidth, keyWidth * 5, getColor("C"));
            drawKey(keyWidth, 0, keyWidth, keyWidth * 5, getColor("D"));
            drawKey(keyWidth * 2, 0, keyWidth, keyWidth * 5, getColor("E"));
            drawKey(keyWidth * 3, 0, keyWidth, keyWidth * 5, getColor("F"));
            drawKey(keyWidth * 4, 0, keyWidth, keyWidth * 5, getColor("G"));
            drawKey(keyWidth * 5, 0, keyWidth, keyWidth * 5, getColor("A"));
            drawKey(keyWidth * 6, 0, keyWidth, keyWidth * 5, getColor("B"));
            drawKey(keyWidth * 15/24, 0, keyWidth * 14/24, keyWidth * 3, getColor("Db", true));
            drawKey(keyWidth * 43/24, 0, keyWidth * 14/24, keyWidth * 3, getColor("Eb", true));
            drawKey(keyWidth * 85/24, 0, keyWidth * 14/24, keyWidth * 3, getColor("Gb", true));
            drawKey(keyWidth * 113/24, 0, keyWidth * 14/24, keyWidth * 3, getColor("Ab", true));
            drawKey(keyWidth * 141/24, 0, keyWidth * 14/24, keyWidth * 3, getColor("Bb", true));
            drawKeyText(keyWidth * 0.5, keyWidth * 4.5, "A");
            drawKeyText(keyWidth * 1.5, keyWidth * 4.5, "S");
            drawKeyText(keyWidth * 2.5, keyWidth * 4.5, "D");
            drawKeyText(keyWidth * 3.5, keyWidth * 4.5, "F");
            drawKeyText(keyWidth * 4.5, keyWidth * 4.5, "G");
            drawKeyText(keyWidth * 5.5, keyWidth * 4.5, "H");
            drawKeyText(keyWidth * 6.5, keyWidth * 4.5, "J");
            drawKeyText(keyWidth * 22/24, keyWidth * 2.8, "W", true);
            drawKeyText(keyWidth * 50/24, keyWidth * 2.8, "E", true);
            drawKeyText(keyWidth * 92/24, keyWidth * 2.8, "T", true);
            drawKeyText(keyWidth * 120/24, keyWidth * 2.8, "Y", true);
            drawKeyText(keyWidth * 148/24, keyWidth * 2.8, "U", true);
        }

        function getColor(note, blackKey) {
            if (selectedNotes[note] === "correctlySelected") {
                return "green";
            } else if (selectedNotes[note] === "correct") {
                return "yellowgreen";
            } else if (selectedNotes[note] === "incorrect") {
                return "red";
            } else if (blackKey) {
                return "#131313";
            } else {
                return "white";
            }
        }
        
        drawPiano();

        function selectPage(page) {
            $("#singleNoteTraining").toggle("slide");
        }
    </script>
</body>

</html>
